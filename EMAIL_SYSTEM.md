# Email Notification System

## Обзор

Система автоматических email-уведомлений для отправки писем клиентам после успешной оплаты заказа через Stripe.

## Компоненты

### 1. Email Service (`server/email-service.ts`)

Основной модуль для отправки email через Manus Notification API.

**Функции:**

- `sendEmail(options)` - Отправка email с произвольным содержимым
- `generateOrderConfirmationEmail(data)` - Генерация HTML-шаблона письма подтверждения заказа
- `sendOrderConfirmationEmail(data)` - Отправка письма подтверждения заказа клиенту

### 2. Интеграция с Stripe Webhook (`server/stripe-webhook.ts`)

При получении события `checkout.session.completed` от Stripe:

1. Создается заказ в базе данных
2. Извлекаются детали заказа из Stripe session
3. Формируется и отправляется email клиенту

## Шаблон Email

### Особенности

- **Многоязычность**: Поддержка немецкого (de) и английского (en) языков
- **Адаптивный дизайн**: Корректное отображение на всех устройствах
- **Брендинг**: Фирменные цвета Möbelhaus (зеленый градиент)
- **Полная информация**: Номер заказа, список товаров, цены, адрес доставки, способ доставки

### Содержание письма

1. **Заголовок** с логотипом и названием магазина
2. **Приветствие** с именем клиента
3. **Номер заказа** в выделенном блоке
4. **Таблица товаров** с ценами и количеством
5. **Итоговая сумма** с разбивкой (товары + доставка)
6. **Адрес доставки**
7. **Способ доставки**
8. **Следующие шаги** - что будет происходить с заказом
9. **Контактная информация** для вопросов
10. **Футер** с юридической информацией

## Использование

### Автоматическая отправка

Email отправляется автоматически при успешной оплате через Stripe webhook. Никаких дополнительных действий не требуется.

### Ручная отправка (для разработки)

```typescript
import { sendOrderConfirmationEmail } from './server/email-service';

await sendOrderConfirmationEmail({
  orderNumber: 'ORD-123456',
  customerName: 'Max Mustermann',
  customerEmail: 'max@example.com',
  items: [
    {
      productName: 'Eiche Esstisch',
      price: 89900, // в центах
      quantity: 1,
      variantColor: 'Natur',
    },
  ],
  subtotal: 89900,
  shippingCost: 990,
  total: 90890,
  shippingMethod: 'standard',
  shippingAddress: 'Max Mustermann\nMusterstraße 123\n1010 Wien\nÖsterreich',
  language: 'de',
});
```

## Конфигурация

### Переменные окружения

Email-сервис использует встроенные переменные Manus:

- `BUILT_IN_FORGE_API_URL` - URL Manus API
- `BUILT_IN_FORGE_API_KEY` - API ключ для аутентификации

Эти переменные настраиваются автоматически платформой Manus.

### Отправитель

По умолчанию: `Möbelhaus <noreply@manus.space>`

Можно изменить в функции `sendEmail()` в параметре `from`.

## Тестирование

### Unit тесты

Запустить тесты генерации шаблонов:

```bash
pnpm test email-service.test.ts
```

Тесты проверяют:
- Генерацию немецкого шаблона
- Генерацию английского шаблона
- Корректность отображения всех товаров
- Правильное форматирование цен
- Отображение способов доставки

### Тестирование отправки

Для тестирования реальной отправки email:

1. Создайте тестовый заказ через Stripe Checkout
2. Используйте тестовую карту: `4242 4242 4242 4242`
3. Проверьте почтовый ящик клиента

## Способы доставки

Система поддерживает следующие способы доставки:

| Код | Немецкий | English |
|-----|----------|---------|
| `standard` | Standard Versand (3-5 Werktage) | Standard Shipping (3-5 business days) |
| `express` | Express Versand (1-2 Werktage) | Express Shipping (1-2 business days) |
| `pickup` | Selbstabholung | Self Pickup |
| `assembly` | Lieferung mit Montage | Delivery with Assembly |

## Обработка ошибок

- Если отправка email не удалась, ошибка логируется, но webhook НЕ возвращает ошибку
- Это гарантирует, что заказ будет создан в БД, даже если email не отправился
- Администратор может отправить email вручную позже

## Расширение

### Добавление новых типов писем

1. Создайте новую функцию генерации шаблона в `email-service.ts`
2. Добавьте функцию отправки с нужными параметрами
3. Интегрируйте в нужное место (webhook, tRPC процедура и т.д.)

### Примеры дополнительных писем

- Уведомление об отправке заказа (с трек-номером)
- Уведомление о доставке
- Напоминание о брошенной корзине
- Запрос отзыва после доставки
- Специальные предложения и акции

## Логирование

Все операции email-сервиса логируются с префиксом `[Email]`:

```
[Email] Successfully sent email to customer@example.com
[Email] Failed to send email: <error details>
```

Webhook также логирует отправку:

```
[Webhook] Order confirmation email sent to customer@example.com
[Webhook] Error sending order confirmation email: <error details>
```

## Безопасность

- API ключ хранится в переменных окружения
- Email отправляется только через защищенный Manus API
- Личные данные клиентов не логируются в консоль
- Webhook проверяет подпись Stripe перед обработкой

## Производительность

- Отправка email не блокирует обработку webhook
- При ошибке отправки webhook продолжает работу
- Среднее время отправки: ~500-1000ms
- Retry механизм не реализован (можно добавить при необходимости)
